
<!-- TOC -->

- [目的](#目的)
- [apk报毒因素](#apk报毒因素)
    - [SdkImportWork代码](#sdkimportwork代码)
    - [xml](#xml)
    - [加密的文件](#加密的文件)
    - [res资源](#res资源)
- [找到报毒代码](#找到报毒代码)
    - [可能报毒的位置](#可能报毒的位置)
        - [res](#res)
        - [assets](#assets)
        - [manifest文件](#manifest文件)
        - [代码过少(可以配合使用，增加代码量)](#代码过少可以配合使用增加代码量)
        - [SdkImportWork代码(重点)](#sdkimportwork代码重点)
    - [对应的确定位置方案](#对应的确定位置方案)
        - [报毒主次(现在代码报毒或者太少代码，那个是主要的)](#报毒主次现在代码报毒或者太少代码那个是主要的)
        - [res](#res-1)
        - [assets](#assets-1)
        - [manifest](#manifest)
        - [代码过少](#代码过少)
        - [SdkImportWork代码](#sdkimportwork代码-1)
- [修改方案](#修改方案)
    - [SdkImportWork代码](#sdkimportwork代码-2)
        - [代码使用不同的写法替换](#代码使用不同的写法替换)
        - [代码结构调整重组](#代码结构调整重组)
    - [修改效果](#修改效果)
- [痛点](#痛点)
- [报毒主次](#报毒主次)
- [确定报毒位置](#确定报毒位置)
    - [文件(0.5天)](#文件05天)
    - [函数(1天)](#函数1天)
- [代码修改(确定思路，实现)数量随机](#代码修改确定思路实现数量随机)
    - [要求](#要求)
- [A 收集信息](#a-收集信息)
- [B 用户其他信息采集](#b-用户其他信息采集)
- [服务端获取屏蔽怀疑释放条件对接(提测)(陈昭村)](#服务端获取屏蔽怀疑释放条件对接提测陈昭村)

<!-- /TOC -->


# 目的  
保证不报毒的情况下，提高能够出包效率
# apk报毒因素
## SdkImportWork代码
* cpu，光传感器，蓝牙检测
* 入口调用代码
* 文件core释放代码
* 加载core代码
* 字符串解密(有没有必要修改加密算法)  
* 反射代码(统一接口调用)
* 创建文件文件夹
* 删除文件文件夹
* 获取进程名
## xml
主要是指manifest文件，组件和权限
## 加密的文件
暂时没有引起报毒
## res资源
主要是指自定义的资源

# 找到报毒代码
## 可能报毒的位置
### res
自定义的资源比如字符串和styles
### assets
存放加密文件
### manifest文件
组件和特殊权限，以及用到的资源
### 代码过少(可以配合使用，增加代码量)
空壳但是权限组件较多
### SdkImportWork代码(重点)
特征代码(?我也不知道是什么样的代码)

## 对应的确定位置方案
### 报毒主次(现在代码报毒或者太少代码，那个是主要的)
### res
随机包中使用的自定义res文件
### assets
暂时没有引起报毒
### manifest
随机或者加密使用的各个组件和资源
### 代码过少
使用别人的core文件反编译之后，加入到我们的apk里面，这里需要注意控制包体的大小。**报毒代码增加代码之后会不会继续报毒**
### SdkImportWork代码
通过删除smail文件，确认哪一个类引起报毒，需要将修改之后的apk上传到virustotal网站，是否破解网站访问，自动化检测结果分为两种，一种是改完之后统一手动上传，另一种是直接代码上传，获取检测结果。第一种相对第二种耗时，第二种需要破解virustotal，实现起来需要一定时间

确定类之后进一步确定是哪个函数或者哪几个函数
* A
1、对apk反编译，得到反编译后的文件，使用文件夹路径作为输入参数   
2、一次删除一个文件(可以排除某些文件)  
3、编译删除某个文件后的文件夹，命名为删除的文件名  
4、将编译得到的apk上传到virustotal检测，并记录结果  
5、重复步骤2-4，直到所有文件都删除过。  
6、如果仍然报毒，则一次删除两个文件，重复2-4的操作  
* B
1、将A中得到的结果作为输入  
2、解析其中的代码，找到每个函数的其实位置  
3、如果输入的参数是多个文件，调到步骤7；否则删除一个函数，回编译生成apk，命名为文件名+删除的函数名  
4、将生成的apk文件上传到virustotal检测，记录结果  
5、重复2-4的步骤，直到没有报毒或者所有的函数都删除  
6、如果仍然报毒，一次删除两个(多个)函数，重复2-4的步骤。到结束  
7、解析其中的代码，找到每个函数的起始结束位置  
8、每次分别删除一个文件的一个函数，回编译生成apk，命名为文件名+删除的函数名  
9、将生成的apk文件上传到virustotal检测，记录结果  
10、重复8-9步骤，直到没有报毒或者所有函数都删除过  
11、如果仍然报毒，一次每个文件删除2个(多个)函数，重复8-9步骤，直到没有报毒或者所有函数删除过  



# 修改方案
## SdkImportWork代码
### 代码使用不同的写法替换
如果替换代码足够有效，并且找到报毒代码，2小时可以修改一套(包括修改调试)
### 代码结构调整重组
重点对报毒的类调整
* 函数拆分
将一个功能拆分成多个函数部分
* 类拆分
一个类分成多个，函数的再组合
* 函数重组
相邻功能的两个函数合并后再重新拆分
* 类重组
一个类里面的函数重新排序
* 类交叉组合
两个类中的函数部分交换

方案一：
代码块，每个代码块可以有多种书写形式，将这样的代码块存储，随机使用。真正调用的时候可以作为一个函数，或者函数中的一个代码段。考虑使用gradle实现

1、将需要的代码拆分成最小单元(输入，输出，前一段代码名，后一段代码名(数组)；如果不提取作为函数，则不需要输入输出)，直接使用这些信息作为文件名
2、第一个开始文件夹命名start(文件夹中有多个版本的代码，每次随机取出一个使用)
3、写入本段代码(是否抽出来作为一个函数)，以及查找后一段代码(如果是数组，这说明这几段代码是不可缺少的无序的)
4、循环步骤3，直到没有后一段代码

类似图的检索结果，可以首先根据前一段代码和后一段代码，检索出所有代码顺序，之后一次性写入，在写入前，随机是否提取作为函数


方案二：
大致实现：每个类分成不同的函数，直接替换类中的内容，重新组装Java类

1、各个函数使用不同的写法作为备用(类名/函数名/具体写法)
2、每个类里使用固定的模板，使用gradle直接替换，也就是说，类里面的函数固定，只填充内容
3、依次读取类的内容，读到特定地方，在备选内容中随机找到适合内容填充代码  

方案三：
使用自定义混淆，混淆后的代码可以包含字符汉字标点符号等

方案一更灵活，更容易改变代码结构
方案二方便，能够改变函数内容，但是结构不容易改变
方案三待验证

提示：  
注解处理器，gradle，混淆

## 修改效果
也就是不报毒（重点）


#痛点 
* 如何获取和确认有效代码
* 如何快速确定报毒位置


**增加的思路**
报毒比例思想
特征代码可能没有超过代码总量一定比例(增加代码数量)，
# 报毒主次

 现有代码报毒或者太少代码，那个是主要的  

1.增加代码总量（1.8M,1.7...）
2.减少特征代码
3.混淆规则变化，生成特殊字符(汉字，标点符号等)？？？
4.代码结构变化
5.3和4组合

需要的方案：
一：
类的数量可以随机
类的结构可以调整(函数个数)
每个小的代码段需要人工介入


二：
动态收集信息

1. 屏蔽用户信息收集

2. (通过的信息是否有没有拦截的)

3. 收集更多的判断条件(屏蔽或者怀疑)


1、确定报毒位置(确定具体如何实现)
2、代码修改(确定思路，实现)数量随机

3、动态屏蔽条件获取，用户因为什么原因被屏蔽，被怀疑(陈昭村)
4、用户其他信息采集(陈昭村)
5、服务端获取屏蔽怀疑释放条件对接(提测)(陈昭村)
6、git提交tag
7、admob请求广告失败zi01_3,是不是没有改路径之前的(这个是点击无效)

确定时间，优先级。

# 确定报毒位置
(确定具体如何实现)
(开发1.5天+测试0.5天，对.bat命令不熟可能会延长开发周期)
## 文件(0.5天)
1. 反编译要检测的apk,作为输入
2. 检索smali文件夹中出去MainActivity和App文件的个数为m
3. 拷贝m次输入文件，每次删除m个文件中的一个
4. 对m个拷贝的文件夹编译成apk文件
5. 手动上传生成的apk文件到virustotal,查看检测结果

## 函数(1天)
1. 将上一步中的报毒文件A作为输入
2. 检索smali文件中函数个数n
3. 确定没一个函数在smali文件中的开始位置Start~i~和结束位置End~i~
4. 拷贝n份反编译后apk文件，每次删除A文件中找到的Start~i~和End~i~之间的文件
5. 编译删除Start~i~和End~i~之间内容的文件夹，编译生成apk
6. 手动上传生成的apk文件到virustotal,查看检测结果

# 代码修改(确定思路，实现)数量随机
准备不同代码版本时间不太好确定
开发时间
## 要求
1. 类的数量可以随机
2. 类的结构可以调整(函数个数)

以函数名f为文件夹，里面含有多(n)个具体实现，以及其他函数的调用标识##函数名##，参数如何使用

函数个数调整
代码段中调用别的代码段时，使用特殊标识，在确定类之后替换

1. 拆分不同功能代码组成不同的函数(每个函数有多种写法备用)
2. 首先随机确定产生类的个数(设置最大和最小值)m个
3. 随机产生每个类函数个数,并且满足f~1~+...+f~m~=m
4. 每个包写入import内容(不精确匹配0.5天)
5. 随机分配每个函数f~n~到对应的类中，函数名，调用的时候，函数调用的时候需要用到类
6. 根据类和函数的个数不同需要修改SdkToolConfig.xml文件内容

类名为：className+i
函数名为：功能+j

# A 收集信息
动态屏蔽条件获取，用户因为什么原因被屏蔽，被怀疑(陈昭村)
增加：
1、被什么屏蔽以及当前各个信息
2、被什么怀疑以及当前各个信息
3、为什么被释放以及当前各个信息
4、正常运行时各个信息(0.5天加自测)
# B 用户其他信息采集
(陈昭村)
增加：
基站信息和gps信息对比是否大致在同一区域(0.5天)
有无距离传感器(可以作为屏蔽条件)
电池温度(能不能拿到)
iccid(固话在sim卡中)(三个0.5天)
# 服务端获取屏蔽怀疑释放条件对接(提测)(陈昭村)
等提测

其中A.B需要跟硕哥确认采集时间，以及完成时间